---
title: "R Notebook"
output: html_notebook
---

```{r, warning=FALSE, message=FALSE}
rm(list = ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(ggrepel)
library(scales)
library(plotly)
library(hrbrthemes)
library(showtext)
```

## Store Data

```{r, warning=FALSE, message=FALSE}
setwd("C:\\Users\\Olga\\0. VS Code\\Github\\visualizations\\")


df<-read.csv("data\\fifa_players.csv")%>%
  filter(Source_File=="combined_fifa_players_20241112_163726")

```

## Data Manipulation

```{r, warning=FALSE, message=FALSE}

league_rankings <- data.frame(
  League = c( "SÃ¼per Lig (TÃ¼rkiye)", "Liga Profesional de FÃºtbol (Argentina)",
             "Eredivisie (Netherlands)", "SÃ©rie A (Brazil)", "Primeira Liga (Portugal)", "Ligue 1 (France)",
             "Serie A (Italy)", "Bundesliga (Germany)", "La Liga (Spain)", "Premier League (England)"),
  League_Rank = 10:1  
)
numeric_vars <- c("Finishing", "Dribbling", "Shot.Power", "Sprint.Speed", 
                  "Attack.Position", "Short.Passing", "Vision", "Long.Passing", 
                  "Stamina", "Standing.Tackle", "Interceptions", "Strength", 
                  "Defensive.Awareness", "Heading.Accuracy", "GK.Reflexes", 
                  "GK.Diving", "GK.Handling", "GK.Positioning", "Overall.Score", 
                  "Potential.Score")


df_clean<- df %>% 
  left_join(league_rankings, by = "League") %>% 
  mutate(
    Wage = as.numeric(str_replace_all(str_remove_all(Wage, "â‚¬"), c("K" = "000", "M" = "000000"))),
    Value = as.numeric(str_replace_all(str_remove_all(Value, "â‚¬"), c("K" = "000", "M" = "000000"))),
    Release.Clause = as.numeric(str_replace_all(str_remove_all(Release.Clause, "â‚¬"), c("K" = "000", "M" = "000000"))),
    Contract.Start = as.numeric(Contract.Start),
    Contract.End = as.numeric(Contract.End),
    Contract.Duration=Contract.End-Contract.Start,
    Height_cm = as.numeric(str_extract(Height, "\\d+")),
    Weight_kg = as.numeric(str_extract(Weight, "\\d+")),
    across(all_of(numeric_vars), 
                ~ as.numeric(str_remove(., "\\+\\d+"))),
    Role = case_when(
      str_detect(Best.Position, "ST|CF|LW|RW") ~ "Attacker",
      str_detect(Best.Position, "CM|CAM|CDM|LM|RM|LWB|RWB") ~ "Midfielder",
      str_detect(Best.Position, "CB|LB|RB") ~ "Defender",
      str_detect(Best.Position, "GK") ~ "Goalkeeper",
      TRUE ~ "Unknown"  
  ),
  LeagueRanked = paste0("#", League_Rank, " ", League)
  ) %>%
  filter(Role != "Unknown", !is.na(Overall.Score), !is.na(Wage),   !is.na(Contract.Duration), League %in% league_rankings$League)%>%
  select(-c(Position, Player.ID, Loan.End, Attacking.Work.Rate, 
            Defensive.Work.Rate, Source_File, Joined.Team))
  

median_overall <- df_clean %>%
  summarise(median_value = median(Overall.Score, na.rm = TRUE)) %>%
  pull(median_value)  # Converts it to a vector

median_potential <- df_clean %>%
  summarise(median_value = median(Potential.Score, na.rm = TRUE)) %>%
  pull(median_value)

df_clean<-df_clean %>% mutate( Quadrant = case_when(
      Overall.Score >= median_overall & Potential.Score >=median_potential ~ "Elite Rising Stars",  # "High Overall, High Potential"
      Overall.Score >= median_overall & Potential.Score < median_potential ~ "Peak Performance", # "High Overall, Low Potential"
      Overall.Score < median_overall & Potential.Score >= median_potential ~ "Future Talents", #  "Low Overall, High Potential"
      Overall.Score < median_overall & Potential.Score < median_potential ~ "Limited Growth" # "Low Overall, Low Potential"
    ))

england<-df_clean%>% filter(League== 	"Premier League (England)")
```

```{r}
colnames(df_clean)
#glimpse(df_clean)
```

## EDA

```{r, warning=FALSE}
###Download Fonts
#must download font awesome locally first! https://fontawesome.com/download
library(hrbrthemes)
library(showtext)
showtext.auto()
setwd("C:\\Users\\Olga\\0. VS Code\\Github\\visualizations\\")
sysfonts::font_add('fs', 'fonts/otfs/Font Awesome 6 Free-Solid-900.otf')
sysfonts::font_add('fb', 'fonts/otfs/Font Awesome 6 Brands-Regular-400.otf')
sysfonts::font_add_google("Open Sans","opensans")
font_sans<-"opensans"
#sysfonts::font_add_google("IBM Plex Sans", "ibm_plex_sans")
font_add_google("IBM Plex Sans", "ibm_plex_sans_bold", bold.wt = 700)


theme_ipsum_rc <-theme_ipsum_rc(base_family = "ibm_plex_sans")+
  theme(
    text=element_text(size=14, color="#333333"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size=16, hjust = 0,vjust = 1,family = "fs", face = "bold", color="666666"),
    axis.text = element_text(size = 14,family = "ibm_plex_sans"),
    panel.grid.minor=element_blank(),
    panel.grid.major=element_line(color="gray90"),
    legend.position="top"
  )
theme_set(theme_ipsum_rc)
```

### Graph #1.

```{r,  fig.width=20, fig.height=6, warning=False}
#install.packages("patchwork")
#install.packages("ggsci")
library(ggsci)
library(patchwork)
# ðŸ“Š **Graph 1
p1 <- ggplot(df_clean) +
  aes(x = Overall.Score, y = reorder(LeagueRanked, -League_Rank), fill = LeagueRanked) +  # Sort leagues by rank
  geom_boxplot( color = "666666") +
 scale_fill_observable()+
  labs(title = "Score Distribution", x = "Overall Score", y = "League") +
   theme( legend.position = "none",plot.title = element_text(size = 14))
  
  

# ðŸ“Š **Graph 2
p2 <- ggplot(df_clean) +
  aes(x = Age, y=reorder(LeagueRanked, -League_Rank), fill = LeagueRanked) +  # Sort leagues by rank
  geom_boxplot( color = "666666") +
  scale_fill_observable()+
  labs(title = "Age Distribution", x = "Age", y = NULL) +
  theme(axis.text.y = element_blank(), legend.position = "none",plot.title = element_text(size = 14))


# ðŸ–¼ **Combine the graphs horizontally**
p1 + p2 + plot_layout(ncol = 2)+ 
  plot_annotation(title = "Overall Score and Age Distribution Across Top Football Leagues")

```

### Graph #2.

```{r,  warning=FALSE, fig.width=20, fig.height=6}

ggplot(df_clean%>% filter(!is.na(Quadrant))) +
         
   aes(x = Overall.Score, y = Potential.Score, color = Quadrant) +
   
   geom_jitter(alpha = 0.6) +
   scale_color_manual(values = c(
    "Elite Rising Stars" = "#91D1C2B2",  
    "Peak Performance" = "gray20",   
    "Future Talents" ="#1b9e77",  
    "Limited Growth" = "666666"   
  )) +
  
   # Horizontal median line for each league
   geom_vline(aes(xintercept = median_overall), color = "gray40", linetype = "dashed", linewidth = 1) +
   
   # Vertical median line for each league
   geom_hline(aes(yintercept = median_potential), color = "gray40", linetype = "dashed", linewidth = 1) +
   
   facet_wrap(vars(reorder(LeagueRanked, League_Rank)),  ncol = 5L) +
   
   labs(title = "Where Future Talants Emerge", 
        x = "Overall Score", 
        y = "Potential Score") +
   
   theme(legend.position = "right",  
         legend.key.height = unit(1, "cm"), 
         plot.title = element_text(size = 14))+
   guides(color = guide_legend(override.aes = list(size = 6)))
```

### Graph #3.

```{r,  fig.width=20, fig.height=6, warning=False}

ggplot(df_clean) +
  aes(x = Overall.Score, y = Contract.Duration) +
 geom_jitter( alpha = 0.5) +
  scale_fill_observable()+
geom_smooth(method = "lm", color = "666666", linetype = "solid", se = FALSE) + 
 facet_wrap(vars(reorder(LeagueRanked, League_Rank)), ncol = 5L)+
  labs(title = "Contract Duration Vs Overall Score", x = "Overall Score", y = "Contract Duration") +
  theme( legend.position = "right",plot.title = element_text(size = 14))
```



## Multi-Linear Regression Models

```{r, warning=FALSE, fig.width=10, fig.height=6}
# Performance_Score= case_when( 
# str_detect(Role, "Attacker") \~ (5 \* as.numeric(Finishing)) + 
# (4 \* as.numeric(Dribbling)) + 
# (3 \* as.numeric(Shot.Power)) + 
# (2 \* as.numeric(Sprint.Speed))+ 
# (1 \* as.numeric(Attack.Position)), 
# str_detect(Role, "Midfielder") \~ (5 \* as.numeric(Short.Passing)) + 
# (3 \* as.numeric(Dribbling)) + 
# (4 \* as.numeric(Vision)) + 
# (2 \* as.numeric(Long.Passing)) + 
# (1 \* as.numeric(Stamina)), 
# str_detect(Role, "Defender") \~ (5 \* as.numeric(Standing.Tackle)) + \
# (4 \* as.numeric(Interceptions)) + \
# (3 \* as.numeric(Strength)) + \
# (2 \* as.numeric(Defensive.Awareness)) + \
# (1 \* as.numeric(Heading.Accuracy)), \
# str_detect(Role, "Goalkeeper") \~ (5 \* as.numeric(GK.Reflexes)) + \
# (4 \* as.numeric(GK.Diving)) + \
# (3 \* as.numeric(GK.Handling)) + \
# (2 \* as.numeric(GK.Positioning))+ \
# (1 \* as.numeric(GK.Positioning)), \
# TRUE \~ as.numeric(Overall.Score) \
# Default if no match \# ),

# Example: Predicting Player Value
# model0 <- lm(Value/1000 ~ Finishing+ Dribbling+ Shot.Power+ Sprint.Speed+Attack.Position+ Age, 
#             data = df)
model1 <- lm(Value/1000 ~ Finishing+ Dribbling+ Shot.Power+ Sprint.Speed+Attack.Position+ Short.Passing+Vision+Long.Passing+Stamina+Standing.Tackle+Interceptions+Strength+Defensive.Awareness+Heading.Accuracy+Age, 
            data = df_clean%>% filter(Role=="Attacker"))
model2 <- lm(Value/1000 ~ Finishing+ Dribbling+ Shot.Power+ Sprint.Speed+Attack.Position+ Short.Passing+Vision+Long.Passing+Stamina+Standing.Tackle+Interceptions+Strength+Defensive.Awareness+Heading.Accuracy+Age, 
            data = df_clean%>% filter(Role=="Midfielder"))
model3 <- lm(Value/1000 ~ Finishing+ Dribbling+ Shot.Power+ Sprint.Speed+Attack.Position+ Short.Passing+Vision+Long.Passing+Stamina+Standing.Tackle+Interceptions+Strength+Defensive.Awareness+Heading.Accuracy+Age, 
            data = df_clean%>% filter(Role=="Defender"))

# Summary of Model
summary(model0)
summary(model1)
summary(model2)
summary(model3)




```

```{r}

```

```{r}
#install.packages("gganimate")
#install.packages("gifski")

library(ggplot2)
library(gganimate)
avg_age<-df_clean%>% group_by(League, Age) %>% summarise(Growth=mean(Growth))
p <- ggplot(avg_age, aes(x = Age, y = Growth, color = League, group = League)) +
  geom_line(size = 1.2, alpha = 0.8) +  # Line plot for trends
  geom_point(size = 2) +  # Points for better visibility
  scale_color_manual(values = c("#E07B39", "#3498db", "#2ecc71", "#f1c40f", "#9b59b6", 
                   "#ff5733", "#16a085", "#8e44ad", "#c0392b", "#2c3e50", "#d35400")) +  # Custom colors for Leagues
  labs(title = "Average Growth by Age Across Leagues",
       subtitle = "Age: {frame_along}",
       x = "Age",
       y = "Growth",
       color = "League") +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 18, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 16, hjust = 0.5),
    axis.title = element_text(size = 14, face = "bold"),
    legend.position = "right"
  ) +
  transition_reveal(Age)  # Animate Age progression

# Save as GIF
animate(p, duration = 10, fps = 10, width = 800, height = 600, renderer = gifski_renderer("age_growth_league.gif"))
 
```

```{r}
ggplot(data=df_clean, aes(x=Wage_K, y=Performance_Score))+
  geom_point()+
  facet_wrap(~League)



ggplot(data=england, aes(x=log(Wage_K), y=Performance_Score, color=Role))+
  geom_point()


lm_model <- lm(log(Wage) ~ Performance_Score, data = df_clean)
summary(lm_model)

ggplot(data=england, aes(x=Wage_K, y=Performance_Score, color = Performance_Score))+
  geom_point(alpha = 0.8, size = 3)+
  geom_smooth(method = "lm", linetype = "dashed", color = "white", se = FALSE)+ 
  scale_x_continuous(labels = scales::comma, name = "Wage (in K)") +
  theme_minimal()



df%>% distinct(League)

# H1: relationship between player wage and their performance

top_players <- england%>% filter(Wage_K>240)

# Create the scatter plot
p <- ggplot(data = england, aes(x = Wage_K, y = Performance_Score, color = Performance_Score, text = mylabel)) +
  
  # Scatter points with gradient color
  geom_boxplot(alpha = 0.8, size = 4) +
  
  # Add regression line (trend)
  geom_smooth(method = "lm", linetype = "dashed", color = "white", se = FALSE) +
  
  # Highlight key players
  geom_text_repel(data = top_players, aes(label = Player), size = 5, color = "white", force = 2,  # Reduce overlap
                  nudge_y = 50,  # Move text upwards slightly
                  direction = "y" ) +

  # Custom color gradient
  scale_color_gradient(low = "#AABCCB", high = "#E07B39") +
  
  # Format X-axis (Wage) with â‚¬ and K
  scale_x_continuous(
    labels = function(x) paste0("â‚¬", x, "K"),
    breaks = seq(0, 500, by = 100),
    name = "Wage"
  ) +
  
  # Format Y-axis (Performance Score)
  scale_y_continuous(name = "Performance Score") +
  
  # Apply dark theme and enhance visibility
  theme_minimal(base_size = 14) +
  theme(
    panel.background = element_rect(fill = "#012030", color = NA),  # Dark background
    panel.grid.major = element_line(color = "#1F3A52", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#012030", color = NA),
    plot.title = element_text(color = "white", size = 20, face = "bold"),
    axis.text = element_text(color = "white", size = 12),
    axis.title = element_text(color = "white", size = 14),
    legend.position = "none"
  ) +
  
  # Add title and caption
  labs(title = "Wage Vs Performance in 	Premier League	Englan League", caption = "Data Source: FIFA Stats")

# Convert to interactive plot with tooltips


annotations_list <- lapply(1:nrow(top_players), function(i) {
  list(
    x = top_players$Wage_K[i],
    y = top_players$Performance_Score[i],
    text = paste0(top_players$Player[i]),
    showarrow = TRUE,
    arrowhead = 0,
    ax = 0, ay = -10,
    font = list(color = "white", size = 12)
  )
})

  
ggplotly(p, tooltip = c("mylabel")) %>%
  layout(annotations = annotations_list)





# H1: Certain positions receive higher wages

# Compute average wage per Role & League
# Compute average wage per Role & League
avg_wage <- df_clean %>% 
  filter(League %in% c("Premier League (England)", "La Liga (Spain)", 
                       "Bundesliga (Germany)", "Serie A (Italy)", "Ligue 1 (France)")) %>%
  group_by(League, Role) %>% 
  summarise(Wage_K = mean(Wage_K, na.rm = TRUE), .groups = "drop") %>%
  
  # Sort leagues by highest average wage (descending)
  arrange(desc(Wage_K)) %>%
  
  # Convert League to factor with ordered levels
  mutate(League = factor(League, levels = unique(League)))  

# Define custom colors for roles
role_colors <- c("Goalkeeper" = "green", 
                 "Defender" = "blue", 
                 "Midfielder" = "purple", 
                 "Attacker" = "red")

# Create bar chart with sorted leagues & larger facet labels
p <- ggplot(data = avg_wage, aes(x = Role, y = Wage_K, fill = Role)) +
  
  geom_col(alpha = 0.8, width = 0.6) +  # Use geom_col() for single values
  
  facet_wrap(~League, scales = "free_y") +  # Allow different y-axis ranges per league
  
  scale_fill_manual(values = role_colors, name = "Player Role") +  # Add legend with custom colors
  
  # Increase facet label size
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(size = 16, face = "bold", color = "white"),  # Bigger facet labels
    panel.background = element_rect(fill = "#012030", color = NA),
    panel.grid.major = element_line(color = "#1F3A52", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#012030", color = NA),
    plot.title = element_text(color = "white", size = 20, face = "bold"),
    axis.text = element_text(color = "white", size = 12),
    axis.title = element_text(color = "white", size = 14),
    
    # Position the legend on the right side
    legend.position = "right",
    legend.text = element_text(color = "white", size = 12),
    legend.title = element_text(color = "white", size = 14, face = "bold")
  ) +
  
  labs(title = "Average Wage by Role Across Leagues", 
       x = "Player Role", 
       y = "Wage (â‚¬K)",
       caption = "Data Source: FIFA Stats")

# Convert to interactive plot
ggplotly(p)

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

---
title: "R Notebook"
output: html_notebook
---

# A Data-Driven Analysis of Football Player Performance and Wage

**Football** is one of the most popular sports in the world, enjoyed by billions of fans and generating huge amounts of money through TV rights, sponsorships, and merchandise. Because of this, football players often earn some of the highest salaries in professional sports. Clubs spend a lot of money on players based on their skills, physical abilities, and overall performance.

This project is divided into two major components:

1.  **EDA** - We will start with exploratory data analysis, and see the connection between player performance and salary to understand what factors influence how much footballers get paid.\
2.  **Regression model** - Then, we will use regression modeling to see how different performance metrics affect player wages, giving us insights into what really drives player value in football.

By the way, to ensure a consistent and meaningful analysis, we focus exclusively on players from the top 10 football leagues, which represent the highest level of competition globally. Additionally, goalkeepers are excluded from the analysis because their performance metrics differ significantly from those of outfield players, and including them could introduce bias into the results.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
rm(list = ls())

library(dplyr)
library(tidyr)
library(ggplot2)
library(stringr)
library(ggrepel)
library(scales)
library(plotly)
library(hrbrthemes)
library(showtext)

###Download Fonts
#must download font awesome locally first! https://fontawesome.com/download
showtext.auto()
setwd("C:\\Users\\Olga\\0. VS Code\\Github\\visualizations\\")
sysfonts::font_add('fs', 'fonts/otfs/Font Awesome 6 Free-Solid-900.otf')
sysfonts::font_add('fb', 'fonts/otfs/Font Awesome 6 Brands-Regular-400.otf')
sysfonts::font_add_google("Open Sans","opensans")
font_sans<-"opensans"
#sysfonts::font_add_google("IBM Plex Sans", "ibm_plex_sans")
font_add_google("IBM Plex Sans", "ibm_plex_sans_bold", bold.wt = 700)

#Setting my theme
theme_ipsum_rc <-theme_ipsum_rc(base_family = "ibm_plex_sans")+
  theme(
    text=element_text(size=14, color="#333333"),
    axis.title.x = element_text(size = 12),
    axis.title.y = element_text(size = 12),
    plot.title = element_text(size=16, hjust = 0,vjust = 1,family = "fs", face = "bold", color="666666"),
    axis.text = element_text(size = 14,family = "ibm_plex_sans"),
    geom_text =element_text(size = 14,family = "ibm_plex_sans"),
    panel.grid.minor=element_blank(),
    panel.grid.major=element_line(color="gray90"),
    legend.position="top"
  )
theme_set(theme_ipsum_rc)
```

## Data

The dataset used in this project was sourced from [SoFIFA](https://sofifa.com/players?type=all&col=wg&sort=desc), a platform that provides detailed information on football players from various leagues worldwide. The data reflects player statistics as of **the end of 2024**

The dataset includes the following key information:

-   **Personal Details:** Player name, age, preferred foot, height, and weight.\
-   **Club & Contract:** League, contract duration, release clauses.\
-   **Performance Metrics:** Technical skills (e.g., finishing, dribbling), physical attributes (e.g., sprint speed, stamina), and mental attributes (e.g., vision, composure).\
-   **Market Value:** Estimated player value and salary information.\
-   **Positional Data:** Best position and player role (attacker, midfielder, defender, goalkeeper).

In this analysis, goalkeepers have been excluded to ensure consistency and accuracy when examining player performance, market value, and salary. This decision was made because goalkeepers have unique performance metrics (such as GK.Reflexes, GK.Diving, GK.Handling, and GK.Positioning) that are not comparable to the metrics used for outfield players, such as Finishing, Dribbling, Passing, and Sprint Speed.

```{r, warning=FALSE, message=FALSE, echo = FALSE}
setwd("C:\\Users\\Olga\\0. VS Code\\Github\\visualizations\\")


df<-read.csv("data\\fifa_players.csv")%>%
  filter(Source_File=="combined_fifa_players_20241112_163726")

```

### Data Manipulation

```{r, warning=FALSE, message=FALSE}

league_rankings <- data.frame(
  League = c( "SÃ¼per Lig (TÃ¼rkiye)", "Liga Profesional de FÃºtbol (Argentina)",
             "Eredivisie (Netherlands)", "SÃ©rie A (Brazil)", "Primeira Liga (Portugal)", "Ligue 1 (France)",
             "Serie A (Italy)", "Bundesliga (Germany)", "La Liga (Spain)", "Premier League (England)"),
  League_Rank = 10:1  
)
numeric_vars <- c("Finishing", "Dribbling", "Shot.Power", "Sprint.Speed", 
                  "Attack.Position", "Short.Passing", "Vision", "Long.Passing", 
                  "Stamina", "Standing.Tackle", "Interceptions", "Strength", 
                  "Defensive.Awareness", "Heading.Accuracy", "GK.Reflexes", 
                  "GK.Diving", "GK.Handling", "GK.Positioning","Overall.Score", 
                  "Potential.Score", "Composure", "Reactions","International.Reputation", "Aggression",
                  "Total.Movement", "Total.Power", "Total.Defending", "Total.Mentality", "Total.Stats" )


df_clean<- df %>% 
  left_join(league_rankings, by = "League") %>% 
  mutate(
    Wage = as.numeric(str_replace_all(str_remove_all(Wage, "â‚¬"), c("K" = "000", "M" = "000000"))),
    Value = as.numeric(str_replace_all(str_remove_all(Value, "â‚¬"), c("K" = "000", "M" = "000000"))),
    Release.Clause = as.numeric(str_replace_all(str_remove_all(Release.Clause, "â‚¬"), c("K" = "000", "M" = "000000"))),
    Contract.Start = as.numeric(Contract.Start),
    Contract.End = as.numeric(Contract.End),
    Contract.Duration=Contract.End-Contract.Start,
    Height_cm = as.numeric(str_extract(Height, "\\d+")),
    Weight_kg = as.numeric(str_extract(Weight, "\\d+")),
    across(all_of(numeric_vars), 
                ~ as.numeric(str_remove(., "\\+\\d+"))),
    Role = case_when(
      #Option1
      str_detect(Best.Position, "LW|RW") ~ "Winger",
      str_detect(Best.Position, "ST|CF") ~ "Striker",
      str_detect(Best.Position, "CM|CAM|CDM") ~ "Central Midfielder",
      str_detect(Best.Position, "CB") ~ "Central Defender",
      str_detect(Best.Position, "RWB|LWB|LB|RB") ~ "Side Defender",
      str_detect(Best.Position, "LM|RM") ~ "Side Midfielder",
      #Option2
        # str_detect(Best.Position, "ST|CF|LW|RW|CAM") ~ "Offensive Playmaker",
        # str_detect(Best.Position, "CM|CDM|LM|RM") ~ "Link Player",
        # str_detect(Best.Position, "CB|LB|RB|RWB|LWB") ~ "Defensive Anchor",
      #Option3
        # str_detect(Best.Position, "ST|CF") ~ "High-Value Striker",
        # str_detect(Best.Position, "LW|RW|CAM") ~ "Creative Forward",
        # str_detect(Best.Position, "CM|CDM") ~ "Engine Room Midfielder",
        # str_detect(Best.Position, "CB") ~ "Defensive Leader",
        # str_detect(Best.Position, "LB|RB|RWB|LWB") ~ "Modern Full-Back",

      TRUE ~ "Unknown"  
  ),
  LeagueRanked = paste0("#", League_Rank, " ", League)
  ) %>%
  filter(Role != "Unknown", !is.na(Overall.Score), !is.na(Wage),   !is.na(Contract.Duration), League %in% league_rankings$League, Best.Position != "GK")%>%
    select(
    -c(Position, Player.ID, Loan.End, Attacking.Work.Rate, Defensive.Work.Rate, 
       Source_File, Joined.Team, Height, Weight, Real.Face, Body.Type, 
       Contract.Start, Contract.End, Total.Goalkeeping),
    -matches("GK.")
  )
  
#Calculate median overall and potential scores across all players
median_overall <- df_clean %>%
  summarise(median_value = median(Overall.Score, na.rm = TRUE)) %>%
  pull(median_value)  # Converts it to a vector

median_potential <- df_clean %>%
  summarise(median_value = median(Potential.Score, na.rm = TRUE)) %>%
  pull(median_value)


#Assign performance categories, calculating the share of each category per League
df_clean<-df_clean %>% mutate( 'Performance Category' = case_when(
      Overall.Score >= median_overall & Potential.Score >=median_potential ~ "Emerging High Performers",  # "High Overall, High Potential"
      Overall.Score >= median_overall & Potential.Score < median_potential ~ "High Peak Performers", # "High Overall, Low Potential"
      Overall.Score < median_overall & Potential.Score >= median_potential ~ "Future High Performers", #  "Low Overall, High Potential"
      Overall.Score < median_overall & Potential.Score < median_potential ~ "Limited Performance" # "Low Overall, Low Potential"
    )) %>%
  group_by(LeagueRanked) %>%
  mutate(Total_Count = n()) %>%
  
  group_by(LeagueRanked, `Performance Category`) %>%
  mutate(Count = n()) %>% 
  
   mutate(Percentage = round((Count / Total_Count) * 100, 0)) %>%
  group_by(LeagueRanked) %>%
  mutate(
    x_pos = case_when(
      `Performance Category` %in% c("Emerging High Performers", "High Peak Performers") ~ 90,
      `Performance Category` %in% c("Future High Performers", "Limited Performance") ~ 50
    ),
    y_pos = case_when(
      `Performance Category` %in% c("Emerging High Performers", "Future High Performers") ~ 90,
      `Performance Category` %in% c("High Peak Performers", "Limited Performance") ~ 60
    )
  ) %>%
  
  ungroup()

avg_wage_per_league <- df_clean %>%
  group_by(LeagueRanked,League_Rank) %>%
  summarise(Average_Wage = mean(Wage, na.rm = TRUE) / 1000) 

head(df_clean)
```

## EDA

### Graph 1. Amount of players across Top Football Leagues

Sorted by League Rank

```{r,  fig.width=10, fig.height=5, warning=False, echo = FALSE}
 ggplot(df_clean) +
  aes(x = reorder(LeagueRanked, -League_Rank), fill = LeagueRanked) +  # Sort leagues by rank
  geom_bar( color = "666666") +
  coord_flip() +
  scale_fill_observable()+
  labs(title = "Amount of Players  Across Top Football Leagues", x = "Count", y = "League") +
   theme( legend.position = "none",plot.title = element_text(size = 14))
  
```

When looking at the player distribution across the top football leagues, it's clear that most leagues have a similar number of players, usually between **400 and 500**. However, there are noticeable differences, especially in the **Argentine** and **Brazilian** leagues.

The **Argentine Primera DivisiÃ³n** has **28 clubs**, which is more than the usual **20 clubs** found in most top leagues. This larger number of teams naturally leads to a higher total number of registered players. In contrast, the **Campeonato Brasileiro SÃ©rie A** has **20 clubs**, similar to many major European leagues.

Even with the same number of clubs, differences in **player registration rules** and **squad management** can cause variations in the total number of players across leagues.

### Graph 2. Overall Score and Age Distribution Across Top Football Leagues

```{r,  fig.width=20, fig.height=6, warning=False, echo = FALSE}
#install.packages("patchwork")
#install.packages("ggsci")
library(ggsci)
library(patchwork)
# ðŸ“Š **Graph 1
p1 <- ggplot(df_clean) +
  aes(x = Overall.Score, y = reorder(LeagueRanked, -League_Rank), fill = LeagueRanked) +  # Sort leagues by rank
  geom_boxplot( color = "666666") +
 scale_fill_observable()+
  labs(title = "Score Distribution", x = "Overall Score", y = "League") +
   theme( legend.position = "none",plot.title = element_text(size = 14))
  
  

# ðŸ“Š **Graph 2
p2 <- ggplot(df_clean) +
  aes(x = Age, y=reorder(LeagueRanked, -League_Rank), fill = LeagueRanked) +  # Sort leagues by rank
  geom_boxplot( color = "666666") +
  scale_fill_observable()+
  labs(title = "Age Distribution", x = "Age", y = NULL) +
  theme(axis.text.y = element_blank(), legend.position = "none",plot.title = element_text(size = 14))


# ðŸ–¼ **Combine the graphs horizontally**
p1 + p2 + plot_layout(ncol = 2)+ 
  plot_annotation(title = "Overall Score and Age Distribution Across Top Football Leagues")

```

The **score distribution** reflects the **league rankings**, with top leagues like the **Premier League**, **La Liga**, and **Bundesliga** having players with **higher average scores**, showing that the best talent is often found in these leagues. On the other hand, lower-ranked leagues have a **wider range of scores**, meaning there's more variety in player performance.

The **age distribution** also shows that **top leagues are focused on signing young, talented players**, as they have **younger average ages** compared to other leagues. This suggests that top leagues are always on the lookout for the next generation of football stars to stay competitive.

### Graph 3. Player Performance Distribution Across Top Football Leagues

This graph shows the distribution of football players based on their **Overall Score** (*x-axis*) and **Potential Score** (*y-axis*) across the top 10 football leagues.

Players are categorized into four **performance groups**, defined using the **median Overall Score** and **median Potential Score**, calculated across all players:

-   **ðŸŸ¢ Emerging High Performers (light green):**\
    Players with **high current performance and high potential**, positioned **above both medians**.

-   **ðŸŸ¢ Future High Performers (dark green):**\
    Players with **lower current performance but high potential**, falling **below the median for Overall Score** but **above the median for Potential Score**.

-   **âš« High Peak Performers (gray):**\
    Players with **high current performance but limited growth potential**, identified as having an **Overall Score above the median** but **Potential Score below the median**.

-   **ðŸ”´ Limited Performance (red):**\
    Players with **low current performance and low potential**, positioned **below both medians**.

```{r,  warning=FALSE, fig.width=20, fig.height=6, echo = FALSE}



ggplot(df_clean%>% filter(!is.na(`Performance Category`))) +
         
   aes(x = Overall.Score, y = Potential.Score, color = `Performance Category`) +
   
   geom_jitter(alpha = 0.6) +
   scale_color_manual(values = c(
    "Emerging High Performers" = "#91D1C2B2",  
   "High Peak Performers" = "gray20",   
    "Future High Performers" ="#1b9e77",  
    "Limited Performance" = "666666"   
  )) +
  

   # Horizontal median line for each league
   geom_vline(aes(xintercept = median_overall), color = "gray40", linetype = "dashed", linewidth = 1) +
   
   # Vertical median line for each league
   geom_hline(aes(yintercept = median_potential), color = "gray40", linetype = "dashed", linewidth = 1) +
  
    geom_text(data = df_clean%>% group_by(LeagueRanked,`Performance Category`)%>%
  distinct(LeagueRanked, `Performance Category`, .keep_all = TRUE) ,
            aes(x = x_pos, y = y_pos, label = paste0(`Percentage`, "%")),
            inherit.aes = FALSE, size = 4.5,hjust = 0.5) +
  
   facet_wrap(vars(reorder(LeagueRanked, League_Rank)),  ncol = 5L) +
   
   labs(title = "Where Future Talants Emerge", 
        x = "Overall Score (Mean = 70)", 
        y = "Potential Score (Mean = 75)") +
   
   theme(legend.position = "right",  
         legend.key.height = unit(1, "cm"), 
         plot.title = element_text(size = 14))+
   guides(color = guide_legend(override.aes = list(size = 8)))
```

Top European leagues like the **Premier League (England)**, **La Liga (Spain)**, and **Bundesliga (Germany)** have a **higher percentage of Emerging High Performers**  attract players who are already performing at a high level while still having room for growth.

In contrast, leagues such as the **SÃ¼per Lig (Turkey)** and **Liga Profesional de FÃºtbol (Argentina)** show a **higher concentration of Limited Performance players** (**63%** and **51%**, respectively).

Leagues like the **Eredivisie (Netherlands)** and **Primeira Liga (Portugal)** stand out for their **strong representation of Future High Performers** (**29%** and **23%**). These leagues are well-known for **developing young talents** who often move on to larger clubs in top-tier competitions.

Meanwhile, leagues such as **Serie A (Italy)** and **Ligue 1 (France)** display a **more balanced distribution** across all performance categories. This reflects a healthy mix of **Veteran stars**, **Future talents**, and **Squad players**.

### Graph 4. Contract Duration vs Overall Score Across Top Football Leagues

This graph illustrates the relationship between players' Overall Score (x-axis) and their Contract Duration in years (y-axis) across the top 10 football leagues. Each black dot represents an individual player, while the red line indicates the trend line (linear regression), showing the general direction of the relationship.

```{r,  fig.width=20, fig.height=6, warning=False, echo = FALSE}

ggplot(df_clean) +
  aes(x = Overall.Score, y = Contract.Duration, fill = LeagueRanked) +  
  geom_jitter(alpha = 0.6, shape = 21, size = 2, color="gray60") +    
  scale_fill_observable() +                                           
  geom_smooth(method = "lm", color = "gray10", linetype = "solid", se = FALSE) + 
  facet_wrap(vars(reorder(LeagueRanked, League_Rank)), ncol = 5L) +
  labs(
    title = "Contract Duration vs Overall Score Across Top Football Leagues",
    x = "Overall Score",
    y = "Contract Duration"
  ) +
  theme(
    legend.position = "none",
    plot.title = element_text(size = 14)
  )
```
While there's a general trend of longer contracts for higher-rated players, the strength of this relationship varies by league. Top leagues seem to reward talent with longer commitments, while others may have less flexibility due to financial or structural factors. 


### Graph 5. Wage Distribution Across Top Football Leagues

Have you ever been curious about how much football players earn? 

This graph shows the average weekly salary (in thousands of euros) for players in the top 10 football leagues.

```{r,  fig.width=11, fig.height=5, warning=False, echo = FALSE }
# Plotting average wage as bars
ggplot(avg_wage_per_league) +
  aes(x = Average_Wage, y = reorder(LeagueRanked, -League_Rank), fill = LeagueRanked) +
  geom_col(color = "666666", width = 0.7) +  # Bar plot with custom color
  scale_fill_observable() +
  labs(
    title = "Average Wage Across Top Football Leagues",
    x = "Average Wage", 
    y = "League"
  ) +
  theme(
    legend.position = "none",
   
  )+
   geom_text(aes(label = paste0(round(Average_Wage, 1), "K")), 
            hjust = -0.1, size = 4, color = "black")
```
The **Premier League (England)** leads with **â‚¬71.6K**, nearly **double** that of the next two highest-paying leaguesâ€”**Serie A (Italy)** at **â‚¬40.5K** and **La Liga (Spain)** at **â‚¬37.8K**. 

Compared to leagues like the **Eredivisie (Netherlands)** (**â‚¬8K**) and **Primeira Liga (Portugal)** (**â‚¬8.7K**), Premier League players earn almost **9 times more**.

Interestingly, the **Seria A(Brazil)** and **SÃ¼per Lig (Turkey)** show relatively **high average wages ** compared to leagues with similar competitive levels. 



```{r,  fig.width=20, fig.height=5, warning=False, echo = FALSE }

library(dplyr)
library(ggplot2)

# df_clean %>%
#  filter(League %in% c("Bundesliga (Germany)", "La Liga (Spain)", "Ligue 1 (France)", "Premier League (England)", 
# "Serie A (Italy)")) %>%
#  ggplot() +
#  aes(x = Role, y = Wage/1000, colour = Role) +
#  geom_violin(fill = "#112446") +
#  scale_color_hue(direction = 1) +
#  hrbrthemes::theme_ipsum_ps() +
#  ylim(0, 200)


avg_wage_per_role <- df_clean %>%
  group_by(Role) %>%
  summarise(Average_Wage = mean(Wage, na.rm = TRUE) / 1000) 


ggplot(avg_wage_per_role) +
  aes(x = Average_Wage, y =  reorder(Role,Average_Wage), fill = Role) +
  geom_col(color = "666666", width = 0.7) +  # Bar plot with custom color
  scale_fill_observable() +
  labs(
    title = "Average Wage Across Top Football Leagues",
    x = "Average Wage", 
    y = "League"
  ) +
  theme(
    legend.position = "none",
   
  )+
   geom_text(aes(label = paste0(round(Average_Wage, 1), "K")), 
            hjust = -0.1, size = 4, color = "black")


avg_wage_by_league_role <- df_clean %>%
  filter(League %in% c("Bundesliga (Germany)", "Serie A (Italy)", "La Liga (Spain)", 
                        "Ligue 1 (France)", "Premier League (England)")) %>%
  group_by(LeagueRanked, Role, League_Rank) %>%
  summarise(Average_Wage = round(mean(Wage, na.rm = TRUE)/1000,0)) %>%
  group_by(LeagueRanked) %>%
  mutate(Role_Rank = dense_rank(desc(Average_Wage))) %>%
  ungroup()%>%
  mutate(Highlight = case_when(
    Role == "Winger" ~ "Winger",
    Role == "Side Midfielder" ~ "Side Midfielder",
    TRUE ~ "Other"  
  ))

# Plotting the average wage
library(tidytext)  # For reorder_within()

# Plot with Roles Ordered Separately for Each League
ggplot(avg_wage_by_league_role) +
  aes(x = reorder_within(Role, -Average_Wage, LeagueRanked),  
      y = Average_Wage, 
      fill = Highlight) +  
  geom_col(width = 0.7) +  
   scale_fill_manual(values = c(
    "Winger" = "#FF6FB5",          
    "Side Midfielder" = "#8BD3E6", 
    "Other" = "gray80"             
  ))+
  facet_wrap(vars(reorder(LeagueRanked, League_Rank)), ncol = 5, scales = "free_x") +  # Allow independent ordering
  scale_x_reordered() +  # Fix axis labels after reordering
  labs(
    title = "Average Wage by Role in Top Football Leagues",
    x = "Role",
    y = "Average Wage (â‚¬K)"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 16, face = "bold"),
    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1), 
    strip.text = element_text(size = 12, face = "bold"),
    axis.text.y = element_text(size = 10),
    legend.position = "none"
  )
```



## Multi-Linear Regression Models

```{r, warning=FALSE, fig.width=10, fig.height=6}
# Performance_Score= case_when( 
# str_detect(Role, "Attacker") \~ (5 \* as.numeric(Finishing)) + 
# (4 \* as.numeric(Dribbling)) + 
# (3 \* as.numeric(Shot.Power)) + 
# (2 \* as.numeric(Sprint.Speed))+ 
# (1 \* as.numeric(Attack.Position)), 
# str_detect(Role, "Midfielder") \~ (5 \* as.numeric(Short.Passing)) + 
# (3 \* as.numeric(Dribbling)) + 
# (4 \* as.numeric(Vision)) + 
# (2 \* as.numeric(Long.Passing)) + 
# (1 \* as.numeric(Stamina)), 
# str_detect(Role, "Defender") \~ (5 \* as.numeric(Standing.Tackle)) + \
# (4 \* as.numeric(Interceptions)) + \
# (3 \* as.numeric(Strength)) + \
# (2 \* as.numeric(Defensive.Awareness)) + \
# (1 \* as.numeric(Heading.Accuracy)), \
# str_detect(Role, "Goalkeeper") \~ (5 \* as.numeric(GK.Reflexes)) + \
# (4 \* as.numeric(GK.Diving)) + \
# (3 \* as.numeric(GK.Handling)) + \
# (2 \* as.numeric(GK.Positioning))+ \
# (1 \* as.numeric(GK.Positioning)), \
# TRUE \~ as.numeric(Overall.Score) \
# Default if no match \# ),

# Example: Predicting Player Value
model0 <- lm( Wage/1000 ~ Finishing+ Dribbling+ Shot.Power+ Sprint.Speed+Attack.Position, 
            data = df_clean%>% filter(Role=="Attacker"))
model1 <- lm(Wage/1000 ~ Finishing+ Dribbling+ Shot.Power+ Sprint.Speed+Attack.Position+ Short.Passing+Vision+Long.Passing+Stamina+Standing.Tackle+Interceptions+Strength+Defensive.Awareness+Heading.Accuracy+Age, 
            data = df_clean%>% filter(Role=="Attacker"))

model_improved <- lm(Wage/1000 ~Total.Movement+ Total.Power+ Total.Defending+Total.Mentality+Total.Stats ,   data = df_clean)
                     
# model2 <- lm(Overall.Score ~ Finishing+ Dribbling+ Shot.Power+ Sprint.Speed+Attack.Position+ Short.Passing+Vision+Long.Passing+Stamina+Standing.Tackle+Interceptions+Strength+Defensive.Awareness+Heading.Accuracy+Age, 
#             data = df_clean%>% filter(Role=="Midfielder"))
# model3 <- lm(Overall.Score ~ Finishing+ Dribbling+ Shot.Power+ Sprint.Speed+Attack.Position+ Short.Passing+Vision+Long.Passing+Stamina+Standing.Tackle+Interceptions+Strength+Defensive.Awareness+Heading.Accuracy+Age, 
#             data = df_clean%>% filter(Role=="Defender"))

# Summary of Model
summary(model0)
summary(model1)
summary(model_improved)



# 5 assumptions
#1. linear
#2. independent error -> Durban watson test
#3. Homoscedasticity -> Residual plot
#4. Normally distribution -> QQ plot
#5. Multicollinearity VIF, Tolerance

```

```{r}
library(car)
#Check for Multicollinearity
vif(model0)
# Residual Diagnostics
par(mfrow = c(2, 2))
plot(model0)

cor(df_clean %>% select(Finishing, Dribbling, Shot.Power, Sprint.Speed, Attack.Position), use = "complete.obs")

cor(df_clean %>% select(Total.Movement,Total.Power, Total.Defending,Total.Mentality,Total.Stats), use = "complete.obs")


```

```{r}
cor(df_clean %>% select(Finishing, Dribbling, Shot.Power, Sprint.Speed, Attack.Position), use = "complete.obs")
```

```{r}
library(robustbase)
model_robust <- lmrob(Overall.Score ~ Finishing + Dribbling + Shot.Power + Sprint.Speed + Attack.Position, 
                      data = df_clean %>% filter(Role == "Attacker"))
summary(model_robust)
```

```{r}

# when we use this?
model_poly <- lm(Overall.Score ~ Finishing + I(Finishing^2) + Dribbling + I(Dribbling^2) +
                   Shot.Power + Sprint.Speed + Attack.Position,
                 data = df_clean %>% filter(Role == "Attacker"))
summary(model_poly)
```

```{r}
model_extended <- lm(Overall.Score ~ Finishing + Dribbling + Shot.Power + Sprint.Speed +
                       Attack.Position + Stamina + Composure + Reactions,
                     data = df_clean %>% filter(Role == "Attacker"))
summary(model_extended)
```

```{r, warning=FALSE}


#library(esquisse)
#esquisser(df_clean)
library(dplyr)
library(ggplot2)

df_clean %>%
 filter(Role %in% "Attacker") %>%
 ggplot() +
 aes(x = Finishing, y = Overall.Score, colour = `Performance Category`) +
 geom_jitter() +
 scale_color_hue(direction = 1) +
 hrbrthemes::theme_ipsum_ps()

df_clean %>%
 filter(Role %in% "Attacker") %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Finishing, y = Overall.Score, colour = `Performance Category`) +
 geom_jitter() +
 scale_color_hue(direction = 1) +
 labs(caption = "the ability to place the ball precisely") +
 hrbrthemes::theme_ipsum_ps()

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Finishing, y = Overall.Score, colour = `Performance Category`) +
 geom_jitter() +
 scale_color_hue(direction = 1) +
 labs(caption = "the ability to place the ball precisely") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Dribbling, y = Overall.Score, colour = `Performance Category`) +
 geom_jitter() +
 scale_color_hue(direction = 1) +
 labs(caption = "Skill in controlling the ball while moving") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Dribbling, y = Overall.Score, colour = `Performance Category`) +
 geom_jitter() +
 scale_color_hue(direction = 1) +
 labs(caption = "Skill in controlling the ball while moving") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Dribbling, y = Overall.Score, colour = `Performance Category`) +
 geom_jitter() +
 scale_color_hue(direction = 1) +
 labs(caption = "Skill in controlling the ball while moving") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Dribbling, y = Overall.Score, colour = `Performance Category`) +
 geom_jitter() +
 scale_color_hue(direction = 1) +
 labs(caption = "Skill in controlling the ball while moving") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Shot.Power, y = Overall.Score, colour = `Performance Category`) +
 geom_point() +
 scale_color_hue(direction = 1) +
 labs(caption = "Skill in controlling the ball while moving") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Shot.Power, y = Overall.Score, colour = `Performance Category`) +
 geom_point() +
 scale_color_hue(direction = 1) +
 labs(caption = "Strength behind a player's shot") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Attack.Position, y = Overall.Score, colour = `Performance Category`) +
 geom_point() +
 scale_color_hue(direction = 1) +
 labs(caption = " Intelligence in getting into goal-scoring areas") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Short.Passing, y = Overall.Score, colour = `Performance Category`) +
 geom_point() +
 scale_color_hue(direction = 1) +
 labs(caption = "Skill in precise passing over short distances") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Vision, y = Overall.Score, colour = `Performance Category`) +
 geom_point() +
 scale_color_hue(direction = 1) +
 labs(caption = "Skill in identifying gaps for key passes") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Long.Passing, y = Overall.Score, colour = `Performance Category`) +
 geom_point() +
 scale_color_hue(direction = 1) +
 labs(caption = " Accuracy in passing over long distances") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Stamina, y = Overall.Score, colour = `Performance Category`) +
 geom_point() +
 scale_color_hue(direction = 1) +
 labs(caption = "Physical capacity to perform consistently over time") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

df_clean %>%
 filter(!is.na(`Performance Category`)) %>%
 ggplot() +
 aes(x = Standing.Tackle, y = Overall.Score, colour = `Performance Category`) +
 geom_point() +
 scale_color_hue(direction = 1) +
 labs(caption = "Skill in cleanly taking the ball without sliding") +
 hrbrthemes::theme_ipsum_ps() +
 facet_wrap(vars(Role))

```

```{r}
#install.packages("gganimate")
#install.packages("gifski")

library(ggplot2)
library(gganimate)
avg_age<-df_clean%>% group_by(League, Age) %>% summarise(Growth=mean(Growth))
p <- ggplot(avg_age, aes(x = Age, y = Growth, color = League, group = League)) +
  geom_line(size = 1.2, alpha = 0.8) +  # Line plot for trends
  geom_point(size = 2) +  # Points for better visibility
  scale_color_manual(values = c("#E07B39", "#3498db", "#2ecc71", "#f1c40f", "#9b59b6", 
                   "#ff5733", "#16a085", "#8e44ad", "#c0392b", "#2c3e50", "#d35400")) +  # Custom colors for Leagues
  labs(title = "Average Growth by Age Across Leagues",
       subtitle = "Age: {frame_along}",
       x = "Age",
       y = "Growth",
       color = "League") +
  theme_minimal(base_size = 14) +
  theme(
    plot.title = element_text(size = 18, hjust = 0.5, face = "bold"),
    plot.subtitle = element_text(size = 16, hjust = 0.5),
    axis.title = element_text(size = 14, face = "bold"),
    legend.position = "right"
  ) +
  transition_reveal(Age)  # Animate Age progression

# Save as GIF
animate(p, duration = 10, fps = 10, width = 800, height = 600, renderer = gifski_renderer("age_growth_league.gif"))
 
```

```{r}
ggplot(data=df_clean, aes(x=Wage_K, y=Performance_Score))+
  geom_point()+
  facet_wrap(~League)



ggplot(data=england, aes(x=log(Wage_K), y=Performance_Score, color=Role))+
  geom_point()


lm_model <- lm(log(Wage) ~ Performance_Score, data = df_clean)
summary(lm_model)

ggplot(data=england, aes(x=Wage_K, y=Performance_Score, color = Performance_Score))+
  geom_point(alpha = 0.8, size = 3)+
  geom_smooth(method = "lm", linetype = "dashed", color = "white", se = FALSE)+ 
  scale_x_continuous(labels = scales::comma, name = "Wage (in K)") +
  theme_minimal()



df%>% distinct(League)

# H1: relationship between player wage and their performance

top_players <- england%>% filter(Wage_K>240)

# Create the scatter plot
p <- ggplot(data = england, aes(x = Wage_K, y = Performance_Score, color = Performance_Score, text = mylabel)) +
  
  # Scatter points with gradient color
  geom_boxplot(alpha = 0.8, size = 4) +
  
  # Add regression line (trend)
  geom_smooth(method = "lm", linetype = "dashed", color = "white", se = FALSE) +
  
  # Highlight key players
  geom_text_repel(data = top_players, aes(label = Player), size = 5, color = "white", force = 2,  # Reduce overlap
                  nudge_y = 50,  # Move text upwards slightly
                  direction = "y" ) +

  # Custom color gradient
  scale_color_gradient(low = "#AABCCB", high = "#E07B39") +
  
  # Format X-axis (Wage) with â‚¬ and K
  scale_x_continuous(
    labels = function(x) paste0("â‚¬", x, "K"),
    breaks = seq(0, 500, by = 100),
    name = "Wage"
  ) +
  
  # Format Y-axis (Performance Score)
  scale_y_continuous(name = "Performance Score") +
  
  # Apply dark theme and enhance visibility
  theme_minimal(base_size = 14) +
  theme(
    panel.background = element_rect(fill = "#012030", color = NA),  # Dark background
    panel.grid.major = element_line(color = "#1F3A52", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#012030", color = NA),
    plot.title = element_text(color = "white", size = 20, face = "bold"),
    axis.text = element_text(color = "white", size = 12),
    axis.title = element_text(color = "white", size = 14),
    legend.position = "none"
  ) +
  
  # Add title and caption
  labs(title = "Wage Vs Performance in 	Premier League	Englan League", caption = "Data Source: FIFA Stats")

# Convert to interactive plot with tooltips


annotations_list <- lapply(1:nrow(top_players), function(i) {
  list(
    x = top_players$Wage_K[i],
    y = top_players$Performance_Score[i],
    text = paste0(top_players$Player[i]),
    showarrow = TRUE,
    arrowhead = 0,
    ax = 0, ay = -10,
    font = list(color = "white", size = 12)
  )
})

  
ggplotly(p, tooltip = c("mylabel")) %>%
  layout(annotations = annotations_list)





# H1: Certain positions receive higher wages

# Compute average wage per Role & League
# Compute average wage per Role & League
avg_wage <- df_clean %>% 
  filter(League %in% c("Premier League (England)", "La Liga (Spain)", 
                       "Bundesliga (Germany)", "Serie A (Italy)", "Ligue 1 (France)")) %>%
  group_by(League, Role) %>% 
  summarise(Wage_K = mean(Wage_K, na.rm = TRUE), .groups = "drop") %>%
  
  # Sort leagues by highest average wage (descending)
  arrange(desc(Wage_K)) %>%
  
  # Convert League to factor with ordered levels
  mutate(League = factor(League, levels = unique(League)))  

# Define custom colors for roles
role_colors <- c("Goalkeeper" = "green", 
                 "Defender" = "blue", 
                 "Midfielder" = "purple", 
                 "Attacker" = "red")

# Create bar chart with sorted leagues & larger facet labels
p <- ggplot(data = avg_wage, aes(x = Role, y = Wage_K, fill = Role)) +
  
  geom_col(alpha = 0.8, width = 0.6) +  # Use geom_col() for single values
  
  facet_wrap(~League, scales = "free_y") +  # Allow different y-axis ranges per league
  
  scale_fill_manual(values = role_colors, name = "Player Role") +  # Add legend with custom colors
  
  # Increase facet label size
  theme_minimal(base_size = 14) +
  theme(
    strip.text = element_text(size = 16, face = "bold", color = "white"),  # Bigger facet labels
    panel.background = element_rect(fill = "#012030", color = NA),
    panel.grid.major = element_line(color = "#1F3A52", size = 0.3),
    panel.grid.minor = element_blank(),
    plot.background = element_rect(fill = "#012030", color = NA),
    plot.title = element_text(color = "white", size = 20, face = "bold"),
    axis.text = element_text(color = "white", size = 12),
    axis.title = element_text(color = "white", size = 14),
    
    # Position the legend on the right side
    legend.position = "right",
    legend.text = element_text(color = "white", size = 12),
    legend.title = element_text(color = "white", size = 14, face = "bold")
  ) +
  
  labs(title = "Average Wage by Role Across Leagues", 
       x = "Player Role", 
       y = "Wage (â‚¬K)",
       caption = "Data Source: FIFA Stats")

# Convert to interactive plot
ggplotly(p)

```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
